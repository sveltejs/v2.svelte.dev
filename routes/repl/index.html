<:Head>
	<title>Svelte REPL</title>
</:Head>

<Layout page='repl'>
	<div class='repl-outer'>
		<AppControls
			:example_contents
			:bundle
			:components
			:data
			bind:selectedExample
		/>

		<div class='repl-inner'>
			<SplitPane type=horizontal on:resize='resizePanes(["editor", "data"])'>
				<section slot=a class='input'>
					<ComponentSelector
						ref:selector
						:components
						bind:selectedComponent
						on:create='createComponent()'
						on:remove='removeComponent(selectedComponent)'
					/>

					<div ref:editorWrapper class='editor-wrapper {{flip}}'>
						{{#if selectedComponent}}
							{{#if showGenerated && selectedComponent.compiled}}
								<CodeMirror ref:editor mode='javascript' code='{{selectedComponent.compiled.code}}' readonly/>
							{{else}}
								<CodeMirror
									ref:editor
									mode='{{selectedComponent.type === "js" ? "javascript" : "handlebars"}}'
									bind:code='selectedComponent.source'
									error='{{sourceError}}'
									errorLoc='{{sourceErrorLoc || runtimeErrorLoc}}'
									warningCount='{{warningCount}}'
									on:navigate='navigate(event)'
								/>
							{{/if}}
						{{/if}}

						<button class='btn editor-toggle' on:click='flip()'>
							<span class='flip-text'>{{showGenerated ? 'output' : 'input'}}</span>
						</button>
					</div>
				</section>

				<div slot=b style='height: 100%;'>
					<SplitPane type=vertical on:resize='resizePanes(["data"])'>
						<div class=pane slot=a >
							<h2 class='show-if-mobile'>Rendered component</h2>

							{{#if loadedSvelte}}
								{{#if bundle}}
									<Viewer :bundle :data :bundleError bind:error='runtimeError' on:change='updateData(event)' on:navigate='navigate(event)'/>
								{{/if}}
							{{else}}
								<p class='loading'>loading Svelte compiler...</p>
							{{/if}}
						</div>

						<div class=pane slot=b >
							<h2 class='show-if-mobile'>data.json</h2>

							<CodeMirror ref:data mode='javascript' bind:code='json' error='{{dataError}}' errorLoc='{{dataErrorLoc}}'/>
						</div>
					</SplitPane>
				</div>
			</SplitPane>
		</div>
	</div>
</Layout>

<style>
	.repl-outer {
		min-height: calc(100vh - 3em);
		padding: 3em 0 0 0;
		background-color: #f4f4f4;
	}

	.repl-inner {
		height: 100%;
	}

	@keyframes pulse {
		0%   { opacity: 1; transform: scale(1.5); }
		50%  { opacity: 0; transform: scale(1); }
		100% { opacity: 1; transform: scale(1.5); }
	}

	@-webkit-keyframes pulse {
		0%   { opacity: 1; transform: scale(1.5); }
		50%  { opacity: 0; transform: scale(1); }
		100% { opacity: 1; transform: scale(1.5); }
	}

	@keyframes fade-in {
		0%   { opacity: 0; }
		100% { opacity: 1; }
	}

	@-webkit-keyframes fade-in {
		0%   { opacity: 0; }
		100% { opacity: 1; }
	}

	.left, .right {
		position: relative;
	}

	@media (max-width: 767px) {
		.left, .right {
			width: 100% !important; /* override divider-set width */
		}

		.top, .bottom {
			height: auto !important;
		}
	}

	.pane {
		width: 100%;
		height: 100%;
	}

	h2 {
		margin: 1em 0 0 0;
		padding: 0 8px;
		font-weight: 500;
		font-size: 1.2em;
	}

	.editor-wrapper {
		z-index: 5;
		transform-style: preserve-3d;
		animation-fill-mode: forwards;
	}

	.repl-inner .editor-toggle {
		position: absolute;
		bottom: 1em;
		right: 1em;
		z-index: 10;
		background: white url(/icons/flip.svg) no-repeat calc(100% - 0.7em) 50%;
		background-size: 1.4em 1em;
		padding-right: 2.5em;
	}

	.flip-text {
		/*display: none;*/
	}

	.editor-toggle:hover .flip-text {
		/*display: inline-block;*/
	}

	.flip-out {
		animation-name: flip-out;
		animation-duration: 0.2s;
		animation-timing-function: ease-in;
	}

	.flip-pause {
		opacity: 0;
	}

	.flip-in {
		animation-name: flip-in;
		animation-duration: 0.2s;
		animation-timing-function: ease-out;
	}

	@keyframes flip-out {
		from { transform: rotateY(0deg); }
		to { transform: rotateY(90deg); }
	}

	@keyframes flip-in {
		from { transform: rotateY(-90deg); }
		to { transform: rotateY(0deg); }
	}

	@media (min-width: 768px) {
		.show-if-mobile {
			display: none;
		}

		.repl-outer {
			min-height: auto;
			height: calc(100vh - 4em);
			background-color: white;
			overflow: hidden;
		}

		.screen-too-small {
			display: none;
		}

		.left, .right, .divider {
			display: block;

		}

		.left, .right {
			height: 100%;
			float: left;
		}

		.top, .bottom {
			position: absolute;
			width: 100%;
		}

		.top { top: 0; }
		.bottom { bottom: 0; }

		.editor-wrapper {
			/* make it easier to interact with scrollbar */
			padding-right: 8px;
			height: auto;
			height: 100%;
		}

		section {
			height: 100%;
		}
	}

	.loading {
		text-align: center;
		color: #999;
		font-weight: 300;
		margin: 2em 0 0 0;
	}

	.input {
		padding: 2.4em 0 0 0;
		perspective: 1500px;
		perspective-origin: 50% 0%;
	}

	@media (min-width: 768px) {
		.input {
			perspective-origin: 50% 50%;
		}
	}

	.repl-outer :global(button) {
		font-family: Rajdhani, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
		font-size: inherit;
		/* background-color: white;
		cursor: pointer; */
		outline: none;
		line-height: 1;
		border: none;
	}

	.repl-outer :global(.btn) {
		display: block;
		float: right;
		padding: calc(0.5em - 1px) 1em;
		margin: 0 0 0 0.5em;
		border-radius: 2px;
		color: rgb(170,30,30);
		border: 1px solid rgba(170,30,30,0.3);
		font-weight: 500;
		box-sizing: border-box;
	}

	.gist-link {
		float: right;
		line-height: 2;
		font-family: Rajdhani;
		font-weight: 400;
		padding: 0 0.1em;
		display: none;
	}

	@media (min-width: 768px) {
		.gist-link {
			display: block;
		}
	}

	.repl-inner :global(.message) {
		position: relative;
		border-radius: 0.2em;
		margin: 0;
		padding: 0.5em 0.5em 0.5em 2.5em;
		color: white;
	}

	.repl-inner :global(.message::before) {
		content: '!';
		position: absolute;
		left: 0.7em;
		top: 0.55em;
		font-size: 0.8em;
		font-weight: 800;
		width: 1em;
		height: 1em;
		text-align: center;
		line-height: 1;
		padding: 0.2em 0.15em 0.1em 0.15em;
		border-radius: 50%;
		color: white;
		border: 2px solid white;
	}

	.repl-inner :global(.error.message) {
		background-color: rgb(170,30,30);
	}

	.repl-inner :global(.warning.message) {
		background-color: rgb(160,100,30);
	}

	.repl-inner :global(.info.message) {
		background-color: #666;
	}

	.repl-inner :global(.error) :global(.filename) {
		cursor: pointer;
	}
</style>

<script>
	import { locate } from 'locate-character';
	import Layout from '../_components/Layout.html';
	import CodeMirror from './_CodeMirror.html';
	import Viewer from './_Viewer.html';
	import ComponentSelector from './_ComponentSelector.html';
	import AppControls from './_AppControls.html';
	import SplitPane from './_SplitPane.html';
	import { getComponentFromGist, saveComponentAsGist } from './_utils/gist.js';
	import debounce from './_utils/debounce.js';
	import * as load from './_utils/load.js';
	import { get } from './_utils/get.js';

	const versionMatch = typeof window !== 'undefined' && /version=([^&]+)/.exec(window.location.search);
	let dataQuery;

	function loadSvelte() {
		const version = versionMatch ? versionMatch[1] : 'latest';
		if (version === 'local') return import(/* webpackChunkName: "svelte" */ 'svelte');
		return load.script(`https://unpkg.com/svelte@${version}/compiler/svelte.js`).then(() => window.svelte);
	}

	function tryParseData(encoded) {
		try {
			const base64 = decodeURIComponent(encoded);
			const json = atob(base64);
			return JSON.parse(json);
		} catch (err) {
			console.error(err.message);
			return {};
		}
	}

	function compile(component) {
		const warnings = [];

		if (component.type === 'js') return { code: component.source, map: null, warnings };

		const { code, map } = svelte.compile(component.source || '', {
			cascade: false,
			name: component.name,
			filename: component.name + '.html',
			dev: true,
			onwarn: warning => {
				warnings.push(warning);
			}
		});

		return { code, map, warnings };
	}

	export default {
		preload({ query }) {
			let gist = null;
			let components = [];
			let selectedComponent;
			let data = {};

			if (query.data) {
				const parsed = tryParseData(query.data);

				components = parsed.components;
				components.forEach(component => {
					if (!component.type) component.type = 'html';
				});

				data = parsed.data;
			}

			if (components && components.length > 0) {
				selectedComponent = components[0];
			} else if (query.gist) {
				gist = query.gist;
			}

			return this.fetch(`api/examples`).then(r => r.json()).then(example_contents => {
				return {
					example_contents,

					gist,
					components,
					selectedComponent,
					data,
					json: JSON.stringify(data, null, '  ')
				};
			});
		},

		data() {
			return {
				horizontalDividerPos: 50,
				verticalDividerPos: 50,
				showGenerated: false,

				selectedExample: null,

				editorRotation: 0,
				flip: ''
			};
		},

		computed: {
			runtimeErrorLoc(runtimeError, selectedComponent) {
				if (!runtimeError || !selectedComponent) return null;
				if (runtimeError.filename !== `${selectedComponent.name}.${selectedComponent.type}`) return;

				return runtimeError.loc;
			},
			githubGist(gist) {
				return 'https://gist.github.com/anonymous/' + gist;
			}
		},

		methods: {
			createComponent() {
				const components = this.get('components');

				const newComponent = {
					name: this.uid++ ? `Component${this.uid}` : 'Component1',
					type: 'html',
					source: '',
					edit: true
				};

				components.push(newComponent);

				this.set({
					components,

					// for some reason we need to unset selectedComponent before
					// resetting it, otherwise the editor remains bound to the
					// previous component. TODO look into this bug
					selectedComponent: null
				});

				this.set({
					selectedComponent: newComponent
				});
				document.getElementById(newComponent.name).scrollIntoView(false);
				this.refs.selector.focusLast();
			},

			removeComponent(component) {
				const components = this.get('components');

				let selectedComponent;

				if (component.entry) {
					// App.html can't be removed
					component.source = '';
					selectedComponent = component;
				} else {
					const index = components.indexOf(component);
					if (~index) {
						components.splice(index, 1);
					} else {
						console.error(`Could not find component! That's... odd`);
					}

					selectedComponent = components[index] || components[components.length - 1];
				}

				this.set({
					components,
					selectedComponent
				});
			},

			flip() {
				if (window.innerWidth < 768) {
					this.flipMobile();
					return;
				}

				if (this.flipping) return;
				this.flipping = true;

				const wrapper = this.refs.editorWrapper;
				const showGenerated = this.get('showGenerated');

				const handleFlipOutEnd = () => {
					wrapper.removeEventListener('animationend', handleFlipOutEnd);
					wrapper.removeEventListener('webkitAnimationEnd', handleFlipOutEnd);

					this.set({
						showGenerated: !showGenerated,
						flip: 'flip-pause'
					});

					const handleFlipInEnd = () => {
						wrapper.removeEventListener('animationend', handleFlipInEnd);
						wrapper.removeEventListener('webkitAnimationEnd', handleFlipInEnd);

						this.flipping = false;

						this.set({ flip: '' });
					}

					wrapper.addEventListener('animationend', handleFlipInEnd);
					wrapper.addEventListener('webkitAnimationEnd', handleFlipInEnd);

					setTimeout(() => {
						this.set({ flip: 'flip-in' });
					});
				}

				wrapper.addEventListener('animationend', handleFlipOutEnd);
				wrapper.addEventListener('webkitAnimationEnd', handleFlipOutEnd);

				this.set({ flip: 'flip-out' });
			},

			flipMobile() {
				const bcr1 = this.refs.editorWrapper.getBoundingClientRect();
				this.set({
					showGenerated: !this.get('showGenerated')
				});

				// if top is visible, keep it that way
				if (bcr1.top > 0) return;

				const bcr2 = this.refs.editorWrapper.getBoundingClientRect();
				const d = bcr2.bottom - bcr1.bottom;
				window.scrollTo(0, window.scrollY + d);
			},

			resizePanes(panes) {
				panes.forEach(pane => {
					this.refs[pane].resize();
				});
			},

			updateData({ key, value }) {
				const data = JSON.parse(this.get('json'));
				data[key] = value;
				this.set({ json: JSON.stringify(data, null, '  ') });
			},

			save() {
				this.set({ saving: true });

				saveComponentAsGist(this.get('components'), this.get('json')).then(id => {
					this.set({
						saving: false,
						gist: id,
						selectedExample: null
					});
					this.updateUrl();
				});
			},

			updateBundle() {
				// TODO do this in a worker
				const components = this.get('components');

				if (!components || !components.length) return;
				if (components.some(c => !c.compiled)) return;

				console.clear();
				console.log(`running Svelte compiler version %c${svelte.VERSION}`, 'font-weight: bold');

				if (this.bundlePromise) this.bundlePromise.cancel();

				const lookup = {};
				let warningCount = 0;
				for (let i = 0; i < components.length; i += 1) {
					const component = components[i];
					const w = component.compiled.warnings.length;
					warningCount += w;

					if (w > 0) {
						console.group(`${component.name}.${component.type}: ${w} ${w === 1 ? 'warning' : 'warnings'}`);
						component.compiled.warnings.forEach(warning => {
							console.warn(warning.message);
							console.log(warning.frame);
						});
						console.groupEnd();
					}

					const path = `./${component.name}.${component.type}`;

					if (path in lookup) {
						this.set({
							bundleError: new Error(`Multiple ${component.name}.${component.type} components`)
						});
						return;
					}

					lookup[path] = {
						code: component.compiled.code,
						map: component.compiled.map
					};
				}

				this.set({ warningCount });

				let cancelled = false;

				let uid = 1;
				const importMap = new Map();
				const input = './App.html';

				this.bundlePromise = rollup.rollup({
					input,
					external: id => {
						return id[0] !== '.';
					},
					plugins: [{
						resolveId(importee, importer) {
							if (importee[0] === '.') return importee;
						},
						load(id) {
							if (id in lookup) return lookup[id];
							if (id[0] === '.') {
								throw new Error(`file does not exist`);
							}

							return null;
						}
					}],
					onwarn(warning) {
						if (warning.code === 'MISSING_GLOBAL_NAME') return;
						console.warn(warning.message);
					}
				}).then(bundle => {
					if (cancelled) return;

					return bundle.generate({
						format: 'iife',
						name: 'SvelteComponent',
						globals: id => {
							const name = `import_${uid++}`;
							importMap.set(id, name);
							return name;
						},
						sourcemap: true
					}).then(({ code, map }) => {
						this.set({
							bundle: {
								code,
								map,
								imports: bundle.imports,
								importMap
							},
							bundleError: null,
							runtimeError: null
						});
					});
				}).catch(err => {
					console.error(err.stack);
					this.set({
						bundleError: err
					});
				});

				this.bundlePromise.cancel = () => {
					cancelled = true;
				};
			},

			updateUrl() {
				if (typeof history === 'undefined') return;

				const gist = this.get('gist');
				const selectedExample = this.get('selectedExample');

				const params = {};
				if (typeof svelte !== 'undefined') {
					params.version = versionMatch && versionMatch[1] === 'local' ? 'local' : svelte.VERSION;
				} else if (versionMatch) {
					params.version = versionMatch[1];
				}

				if (gist) {
					params.gist = gist;
				} else if (selectedExample) {
					params.example = selectedExample.id;
				} else if (dataQuery) {
					params.data = dataQuery;
				}

				const queryString = Object.keys(params).map(key => `${key}=${params[key]}`).join('&');
				const url = queryString ? `/repl?${queryString}` : '/repl';

				history.replaceState({}, 'x', url);
			},

			navigate(filename) {
				const name = filename.replace(/\.html$/, '');
				const { components, selectedComponent } = this.get();

				if (selectedComponent.name === name) return;

				this.set({
					selectedComponent: components.find(c => c.name === name)
				});
			},

			findExample(id) {
				const { example_contents } = this.get();

				id = decodeURIComponent(id);

				for (let i = 0; i < example_contents.length; i += 1) {
					const group = example_contents[i];
					for (let j = 0; j < group.examples.length; j += 1) {
						const example = group.examples[j];
						if (example.id === id) return example;
					}
				}
			}
		},

		oncreate() {
			this.uid = 0;
			this.flipping = false;
			this.bundlePromise = null;

			let exampleComponents;
			let lastSelectedExample;

			const { gist, components } = this.get();
			if (!gist && components.length === 0) {
				const exampleMatch = /example=([^&]+)$/.exec(window.location.search);
				const selectedExample = this.findExample(exampleMatch ? exampleMatch[1] : 'hello-world');
				this.set({ selectedExample });
			}

			this.observe('selectedExample', example => {
				if (!example) return;
				const id = example.id;

				lastSelectedExample = id;
				fetch(`api/examples/${id}`).then(r => r.json()).then(example => {
					exampleComponents = stringifyComponents(example.components);

					if (window.svelte) {
						example.components.forEach(component => {
							component.compiled = compile(component);
						});
					}

					this.set({
						components: example.components,
						selectedComponent: example.components[0],
						json: JSON.stringify(example.data, null, '  ')
					});

					this.updateBundle();
				});

				this.set({ gist: null });
				this.updateUrl();
			});

			if (!this.get('gist')) {
				this.set({ json: JSON.stringify(this.get('data'), null, '  ') });
			}

			this.observe('gist', gist => {
				if (!gist) return;

				if (this.promise) this.promise.cancel();
				this.promise = getComponentFromGist(gist);

				this.promise
					.then(({ components, json }) => {
						if (window.svelte) {
							components.forEach(component => {
								try {
									component.compiled = compile(component);
								} catch (err) {
									console.error(err.stack);

									this.set({
										sourceError: err,
										sourceErrorLoc: err.loc
									});
								}
							});
						}

						this.set({ components, json, selectedComponent: components[0] });
					})
					.catch(err => {
						alert('Error loading from gist.github.com – please try again later!');
						console.error(err.stack);
					});

				this.set({ selectedExample: null });
				this.updateUrl();
			});

			loadSvelte().then(svelte => {
				window.svelte = svelte;

				this.set({ loadedSvelte: true });

				this.get('components').forEach(component => {
					try {
						component.compiled = compile(component);
					} catch (err) {
						console.error(err.stack);

						this.set({
							sourceError: err,
							sourceErrorLoc: err.loc
						});
					}
				});

				this.observe('selectedComponent', (selectedComponent, previousComponent) => {
					if (!selectedComponent) return;
					if (previousComponent && selectedComponent !== previousComponent) return;

					// if component has been edited, unset selectedExample
					if (stringifyComponents(this.get('components')) !== exampleComponents) {
						this.set({ selectedExample: null });
					}

					try {
						selectedComponent.compiled = compile(selectedComponent);
						this.set({ selectedComponent, sourceError: null, sourceErrorLoc: null });

						if (this.get('loadedRollup')) {
							this.updateBundle();
						}
					} catch (err) {
						console.error(err.stack);

						this.set({
							sourceError: err,
							sourceErrorLoc: err.loc
						});
					}
				});

				this.updateUrl();
			});

			import(/* webpackChunkName: "rollup" */ 'rollup/dist/rollup.browser.js').then(rollup => {
				this.set({ loadedRollup: true });
				window.rollup = rollup;

				this.updateBundle();
			});

			this.observe('json', json => {
				try {
					this.set({
						data: JSON.parse(json),
						dataError: null,
						dataErrorLoc: null
					});
				} catch (err) {
					console.error(err.stack);

					const match = /in JSON at position (\d+)/.exec(err.message);

					if (match) {
						const loc = locate(json, +match[1], { offsetLine: 1 });
						this.set({
							dataError: {
								message: err.message.slice(0, match.index).trim(),
								loc
							},
							dataErrorLoc: loc
						});
					}
				}
			});
		},

		components: {
			Layout,
			CodeMirror,
			Viewer,
			ComponentSelector,
			AppControls,
			SplitPane
		}
	};

	function stringifyComponents(components) {
		return JSON.stringify(
			components.map(component => {
				return {
					name: component.name,
					source: component.source
				};
			})
		);
	}
</script>
